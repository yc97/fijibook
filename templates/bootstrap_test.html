<!DOCTYPE html>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=1" />

<html lang="zh-CN">
<link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link href="../static/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<head>
    <title>FijiBook 首页</title>
</head>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=XGvfZRcqMC056a6GSpg81vIO"></script>

<body>
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"></button>
                <a class="navbar-brand" href="#">FijiBook</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/index">Home</a></li>
                    <!--<li><a href="#about">About</a></li>-->
                    <!--<li><a href="#contact">Contact</a></li>-->
                    <!--<li class="dropdown">-->
                        <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>-->
                        <!--<ul class="dropdown-menu">-->
                            <!--<li><a href="#">Action</a></li>-->
                            <!--<li role="separator" class="divider"></li>-->
                            <!--<li class="dropdown-header">Nav header</li>-->
                            <!--<li><a href="#">Separated link</a></li>-->
                        <!--</ul>-->
                    <!--</li>-->
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a id="user" href="#user">{{user}}</a></li>
                    <li class="active"><a href="/logout">注销</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <!--<div class="container theme-showcase" role="main">-->
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <div class="jumbotron">
                    <h1> 非记不可 </h1>
                    <p> 基于地理位置的记账好帮手~</p>
                </div>
            </div>
        </div>
        <!--</div>-->
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <form name="info" method="post" action="/index" onSubmit="return validate_form(this)">
                {% raw xsrf_form_html() %}
                <div class="form-group">
                    <div class="input-group input-group-lg">
                        <span class="input-group-addon">金额:</span>
                        <input class="form-control" type="number" step="0.01" id="money" name="money" required="required" placeholder="0.00" aria-describedby="sizing-addon1">
                    </div>
                </div>
                <!--<div class="col-md-12 col-xs-12">-->
                    <ul class="nav nav-tabs ">
                        <li id="navExpense" class="active" role="presentation">
                            <a href="#expensetypes" data-toggle="tab" name="expenses"><p>支出</p></a>
                        </li>
                        <li id="navIncome" role="presentation">
                            <a href="#incometypes" data-toggle="tab" name="income"><p>收入</p></a>
                        </li>
                    </ul>
                <!--</div>-->
                <input id="moneySelect" type="hidden" name="moneySel" value="expenses"/>

                <div id="myTabContent" class="tab-content">
                   <div class="tab-pane in active" id="expensetypes">
                       <div class="row">
                           <div class="col-md-12"><br />
                               <div class="btn-group" data-toggle="buttons">
                                    {% for k in expensebody[0:12] %}
                                        {% for k1 in k %}
                                                <div class="col-md-3 col-xs-6">
                                                    <!--<h3>-->
                                                        <label class="btn btn-default btn-group-justified">
                                                            {% if k==expensebody[0] %}
                                                            <input type="radio"  id="firstExType" name="type" value="{{k1}}" autocomplete="off" required="required" checked="checked">{{k1}}
                                                            {%else%}
                                                            <input type="radio"  name="type" value="{{k1}}" autocomplete="off" required="required">{{k1}}
                                                            {% end %}
                                                        </label>
                                                    <!--</h3>-->
                                                </div>
                                        {% end %}
                                    {% end %}
                                   <div id="moreTypes" class="collapse fade">
                                       {% for k in expensebody[12:] %}
                                        {% for k1 in k %}
                                                <div class="col-md-3 col-xs-6">
                                                    <!--<h3>-->
                                                        <label class="btn btn-default btn-group-justified">
                                                            <input type="radio"  name="type" value="{{k1}}" autocomplete="off" required="required">{{k1}}
                                                        </label>
                                                    <!--</h3>-->
                                                </div>
                                        {% end %}
                                    {% end %}
                                   </div>
                               </div>
                               <div class="col-md-12"><br />
                                   <button id="moreTypeBtn" type="button" class="btn btn-default btn-group-justified" data-toggle="collapse" data-target="#moreTypes">更多分类</button>
                               </div>
                           </div>
                        </div>
                   </div>
                   <div class="tab-pane" id="incometypes">
                        <div class="row">
                           <div class="col-md-12 "><br />
                               <div class="btn-group" data-toggle="buttons">
                                   {% for k in incomebody %}
                                        {% for k1 in k %}
                                            <div class="col-md-3 col-xs-6">
                                                <!--<h3>-->
                                                    <label class="btn btn-default btn-group-justified">
                                                        {% if k==incomebody[0] %}
                                                            <input type="radio"  id="firstIncomeType" name="type" value="{{k1}}" autocomplete="off" required="required" >{{k1}}
                                                            {%else%}
                                                            <input type="radio"  name="type" value="{{k1}}" autocomplete="off" required="required">{{k1}}
                                                        {% end %}
                                                    </label>
                                                <!--</h3>-->
                                            </div>
                                        {% end %}
                                    {% end %}
                               </div>
                           </div>
                        </div>
                   </div>
                </div>


                <br />
                <!--<div class="page-header"></div>-->
                <div class="row">
                    <div class="col-md-6 col-xs-12">
                        <div class="input-group input-group-sm">
                            <span class="input-group-addon">定位:</span>
                            <input type="hidden" id="street" name="street"  value="" >
                            <input type="text" id="inputLocation" name="inputLocation" class="form-control" placeholder="Your Location">
                        </div><!-- /input-group -->
                    </div>
                    <div class="col-md-3 col-xs-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-addon">经度:</span>
                            <input type="text" id="lng" name="lng" class="form-control" placeholder="Your Location">
                        </div><!-- /input-group -->
                    </div>
                    <div class="col-md-3 col-xs-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-addon">纬度:</span>
                            <input type="text"  id="lat" name="lat" class="form-control" placeholder="Your Location">
                        </div><!-- /input-group -->
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col-md-12 col-xs-12">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingOne">
                                <h4 class="panel-title">
                                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        切换位置
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-6 col-xs-12">
                                            <div id="locationSel"></div>
                                        </div>
                                        <div class="col-md-6 col-xs-12">
                                            <div id="maps" style="height:300px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8 col-xs-12">
                        <div class="form-group">
                            <div class="input-group input-group-lg">
                                <span class="input-group-addon">备注:</span>
                                <input class="form-control" type="text"  name="remark"  placeholder="Details！" aria-describedby="sizing-addon1">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-xs-12">
                        <input class="btn btn-lg btn-success btn-group-justified" type="submit" value="非记不可 ">
                    </div>
                </div>

            </form>
            </div>
        </div>
        <div class="row" style="display:none">
            <!--<div class="alert alert-warning" role="alert">-->
                <div class="col-md-4 col-md-12">
                    <p> 现在你有  <mark>{{recSum}}</mark>条记录! </p>
                </div>
                <div class="col-md-6 col-xs-12">
                    <p>  最新的记录的添加时间：<mark>{{newTime}}</mark>  </p>
                </div>
            <!--</div>-->
        </div>
        <br /><br />
        <div class="row">
            <div class="col-md-4 col-xs-12">
                <span>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#myModal">
                        选择日期
                    </button>
                </span>
                <span >
                    <input type="text" autocomplete="off" id="mirror_field" value="{{today}}" readonly />
                </span>
            </div>
            <div class="col-md-8 col-xs-12">
                  <ul class="nav nav-pills">
                      <li role="presentation"><a name="dateOptions" id="6">six</a></li>
                      <li role="presentation"><a name="dateOptions" id="5">five</a></li>
                      <li role="presentation"><a name="dateOptions" id="4">four</a></li>
                      <li role="presentation"><a name="dateOptions" id="3">three</a></li>
                      <li role="presentation"><a name="dateOptions" id="2">two</a></li>
                      <li role="presentation"><a name="dateOptions" id="1">yesterday</a></li>
                      <li role="presentation" class="active"><a id="0" name="dateOptions">today</a></li>
                  </ul>
            </div>
            <div class="col-md-12 col-xs-12">
                <!-- 模态框（Modal） -->
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                   <div class="modal-dialog">
                      <div class="modal-content">
                         <div class="modal-header">
                            <button type="button" class="close"
                               data-dismiss="modal" aria-hidden="true">
                                  &times;
                            </button>
                            <h4 class="modal-title" id="myModalLabel">
                               选择日期
                            </h4>
                         </div>
                         <div class="modal-body">
                            <form action="" class="form-horizontal"  role="form">
                            <fieldset>
                                <div class="form-group">
                                    <div class="input-group date form_date col-md-8 col-xs-12" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd">
                                        <input id="dateSel" class="form-control" type="text" value="" readonly>
                                        <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                                        <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                                    </div>
                                    <input type="hidden" id="dtp_input2" value="" /><br/>
                                </div>
                            </fieldset>
                        </form>
                         </div>
                         <div class="modal-footer">
                            <button type="button" class="btn btn-default"
                               data-dismiss="modal">关闭
                            </button>
                            <!--<button type="button" class="btn btn-primary">-->
                               <!--提交更改-->
                            <!--</button>-->
                         </div>
                      </div><!-- /.modal-content -->
                </div><!-- /.modal -->
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 col-xs-12">
                <table class="table table-striped">
                    <thead >
                        <tr >
                            {% for i in thead %}
                                <th >{{i}}</th>
                            {% end %}
                        </tr>
                    </thead>
                        {% for j in tbody %}
                            <tbody id="recordsTb">
                                <tr>
                                    {% for j1 in j %}
                                        <td>{{j1}}</td>
                                    {% end %}
                                </tr>
                            </tbody>
                        {% end %}
                </table>
            </div>
        </div>

        <br />
        <br />
        <br />
</div>

<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../static/js/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="../static/js/locales/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
</body>
</html>

<script type="text/javascript">
  $(document).ready(function(){
    var strToday=$('#mirror_field').val();
    var dateToday = new Date(strToday);
    //today=myDate.toLocaleDateString();
    //console.info("today:",dateToday);

    //初始化日期导航条
    options=$("[name='dateOptions']");
    var i=options.length;
    options.each(function(){
        i--;
        var dd=GetSomeDate(i);
        $(this).text(dd.getDate());
    });
    //获取某天的日期
    function GetSomeDate(AddDayCount) {
        var dd = new Date(strToday);
        dd.setDate(dd.getDate()-AddDayCount);//获取AddDayCount天前的日期
        //var y = dd.getFullYear();
        //var m = dd.getMonth()+1;//获取当前月份的日期
       // var d = dd.getDate();
        //return y+"-"+m+"-"+d;
        return dd;
    }
    //初始化日期选择器
    $('.form_date').datetimepicker({
        format: "yyyy-mm-dd",
        language:  'zh-CN',
        weekStart: 1,
        //todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0,
		endDate: strToday,
		pickerPosition: "bottom-left",
		linkField: "mirror_field",
        linkFormat: "yyyy-mm-dd"
    });
    //日期选择器日期change事件函数
    $('.form_date').datetimepicker().on('changeDate', function(ev){
        getRemoteRecord();
    });
    //日期导航条点击事件触发函数
    $("[name='dateOptions']").click(function(){
        $('.nav-pills > li').removeClass('active');//取消全部active
        $(this).parents().addClass('active');//当前点击设为active
        var agoNum=parseInt($(this).attr("id"));
        var dd=GetSomeDate(agoNum);//获取当前选择的日期
        var y = dd.getFullYear();//获取年份
        var m = dd.getMonth()+1;//获取当前的月份，0-11代表1-12所以+1
        var d = dd.getDate();//获取几号
        strdate=y+"-"+m+"-"+d;
        $('#mirror_field').val(strdate);
        $("input#dateSel").val(strdate);
        getRemoteRecord();
        });

    //发出请求 获取json数据并显示在table
    function getRemoteRecord(){
        $("#recordsTb tr").remove();
        user=$("a#user").text();
        //console.info("user:",user);
        strdate = $("input#dateSel").val();
        //console.info("strdate:",strdate);
        $.getJSON("/record",{user:user,myDate:strdate},function(records){
            $.each(records,function(i,record){
                var newRow = "<tr><td>"+record['0']+"</td><td>"+record['1']+"</td><td>"+record['2']+"</td><td>"+record['3']+"</td><td>"+record['4']+"</td></tr>";
                $("#recordsTb").append(newRow);
            });
        });
    }
  });
</script>

<script type="text/javascript">
	var map = new BMap.Map("maps");//创建新的地图
	var point = new BMap.Point(116.331398,39.897445);//在地图中有一个点
	map.centerAndZoom(point,16);//设置中心点和级别
	var geolocation = new BMap.Geolocation();//地理位置
	var gc = new BMap.Geocoder();//位置编码
	geolocation.getCurrentPosition(function(r)
	{
		if(this.getStatus() == BMAP_STATUS_SUCCESS)
		{
		    //添加标记
		    var myIcon = new BMap.Icon("http://api.map.baidu.com/img/markers.png", new BMap.Size(23, 25),
            {
                offset: new BMap.Size(10, 25),
                imageOffset: new BMap.Size(0, 0 - 12 * 25)
            });
            var mk = new BMap.Marker(r.point, {icon: myIcon});
            point = r.point;
            map.addOverlay(mk)

			var poiR = 500//设定poi半径
			var poiNum = 10//设定poi数量
			map.panTo(r.point);//把定位点转到
			//map.addOverlay(new BMap.Circle(r.point,poiR));        //添加一个圆形覆盖物
			//document.getElementById("location").innerHTML = r.point.lng+', '+r.point.lat;
			//地址编码转码，对指定的坐标点进行反地址解析。如果解析成功，则回调函数的参数为GeocoderResult对象，否则回调函数的参数为null。(自 1.1 新增)
			//POI参数
			var mOption = {
			    poiRadius : poiR,
			    numPois : poiNum
			}
			gc.getLocation(r.point, function(rs)
			{
			    //GeocoderResult对象里有addressComponments和surroundingPois
                var addComp = rs.addressComponents;
                var surPois = rs.surroundingPois;
                var business = rs.business;
                //document.getElementById("address").innerHTML =(addComp.province + ", " + addComp.city + ", " +
                //    addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);
                document.getElementById("lng").value = r.point.lng;
                document.getElementById("lat").value = r.point.lat;
                var locationStreet = (addComp.province + ", " + addComp.city + ", " +
                    addComp.district + ", " + addComp.street + ", " + addComp.streetNumber + ", ")
                document.getElementById("street").value = locationStreet;
                document.getElementById("inputLocation").value = locationStreet + surPois[0].title;
                if (surPois.length < 10)
                    var maxI = surPois.length;
                else
                    var maxI = 10;
                for (var i=0;i<surPois.length;i++)
                {
                    var title = String.fromCharCode('A'.charCodeAt()+i) + '.' + surPois[i].title;
                    if (i==0)
                        document.getElementById("locationSel").innerHTML += ('<div class="col-md-4 col-xs-12"><p><input type="radio" onClick="javascript:check()" checked="checked" name="locationSel" value="'
                        + surPois[i].title + '"/> ' + title + '</p></div>');
                    else
                        document.getElementById("locationSel").innerHTML += ('<div class="col-md-4 col-xs-12"><p><input type="radio" onClick="javascript:check()" name="locationSel" value="'
                        + surPois[i].title + '"/> ' + title + '</p></div>');
                    var myIcon = new BMap.Icon("http://api.map.baidu.com/img/markers.png", new BMap.Size(23, 25),
                    {
                        offset: new BMap.Size(10, 25),
                        imageOffset: new BMap.Size(0, 0 - i * 25)
                    });
                    var mk1 = new BMap.Marker(surPois[i].point, {icon: myIcon});
                    map.addOverlay(mk1);
                }
            }
            ,mOption);
		}
		else {
			alert('failed'+this.getStatus());
		}
	},{enableHighAccuracy: true})
	//关于状态码
	//BMAP_STATUS_SUCCESS	检索成功。对应数值“0”。
	//BMAP_STATUS_CITY_LIST	城市列表。对应数值“1”。
	//BMAP_STATUS_UNKNOWN_LOCATION	位置结果未知。对应数值“2”。
	//BMAP_STATUS_UNKNOWN_ROUTE	导航结果未知。对应数值“3”。
	//BMAP_STATUS_INVALID_KEY	非法密钥。对应数值“4”。
	//BMAP_STATUS_INVALID_REQUEST	非法请求。对应数值“5”。
	//BMAP_STATUS_PERMISSION_DENIED	没有权限。对应数值“6”。(自 1.1 新增)
	//BMAP_STATUS_SERVICE_UNAVAILABLE	服务不可用。对应数值“7”。(自 1.1 新增)
	//BMAP_STATUS_TIMEOUT	超时。对应数值“8”。(自 1.1 新增)

	function check()
	{
        var flag=0;
        for(i=0; i<document.info.locationSel.length;i++)
            if(document.info.locationSel[i].checked==true)
            {
                document.info.inputLocation.value = document.info.street.value + document.info.locationSel[i].value;
                break;
            }
    }

    function validate_required(field,alerttxt)
    {
    with (field)
      {
      if (value==null||value=="")
        {alert(alerttxt);return false}
      else {return true}
      }
    }

    function validate_form(thisform)
    {
    with (thisform)
      {
      if (validate_required(money,"请输入金额!")==false)
        {money.focus();return false}
      }
    }

   $(function(){
      $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
          // 获取已激活的标签页的名称
          var activeTabName = $(e.target).attr("name");
          //console.info(activeTabName);
          document.getElementById("moneySelect").value = activeTabName;

          if (activeTabName =="income")
            {document.getElementById("firstIncomeType").checked=true;}
          else if (activeTabName =="expenses")
            {document.getElementById("firstExType").checked=true;}
          // 获取前一个激活的标签页的名称
          //var previousTab = $(e.relatedTarget).text();
          //$(".active-tab span").html(activeTab);
         // $(".previous-tab span").html(previousTab);
      });

       $('#moreTypes').on('shown.bs.collapse', function () {
         document.getElementById("moreTypeBtn").innerHTML = "收起";})

       $('#moreTypes').on('hidden.bs.collapse', function () {
         document.getElementById("moreTypeBtn").innerHTML = "更多分类";})
   });


</script>
